#CXXFLAGS= -O0 -g -DDEBUG_BUILD -DNO_STORAGE -Wall -pedantic -std=c++0x
CXXFLAGS= -std=c++0x -O3 -DNO_OUTPUT -DNO_STORAGE -Wall


ifdef DEBUG
ifeq (${DEBUG}, 0)
#CXXFLAGS= -O0 -g -DNO_STORAGE -DNO_OUTPUT
CXXFLAGS= -O0 -g -DNO_STORAGE
endif
endif
ifdef PROFILE
CXXFLAGS = -pg
endif 

EXE_NAME=NVDSim
LIB_NAME=libnvdsim.so
LIB_NAME_MACOS=libnvdsim.dylib

SRC = $(wildcard *.cpp)
OBJ = $(addsuffix .o, $(basename $(SRC)))
POBJ = $(addsuffix .po, $(basename $(SRC)))
REBUILDABLES=$(OBJ) ${POBJ} $(EXE_NAME) $(LIB_NAME)

all: ${EXE_NAME} 

lib: ${LIB_NAME}

#   $@ target name, $^ target deps, $< matched pattern
$(EXE_NAME): $(OBJ)
	$(CXX) $(CXXFLAGS) -o $@ $^ 
	@echo "Built $@ successfully" 

libnvdsim.a: $(OBJ)
	ar crs $@ $(OBJ)
	@echo "Built $@ successfully" 


${LIB_NAME}: ${POBJ}
	$(CXX) -g -shared -Wl,-soname,$@ -o $@ $^
	@echo "Built $@ successfully"

${LIB_NAME_MACOS}: ${POBJ}
	$(CXX) -g -dynamiclib -o $@ $^
	@echo "Built $@ successfully"

#include the autogenerated dependency files for each .o file
-include $(OBJ:.o=.dep)
-include $(POBJ:.po=.dep)

# build dependency list via gcc -M and save to a .dep file
%.dep : %.cpp
	@$(CXX) -M $(CXXFLAGS) $< > $@

# build all .cpp files to .o files
%.o : %.cpp
	$(CXX) $(CXXFLAGS) -o $@ -c $<

MBOBSim.o: TraceBasedSim.cpp
	$(CXX) ${CXXFLAGS} -DMBOB_SYSTEM -o $@ -c $<

%.po : %.cpp %.o
	$(CXX) -std=c++0x -g -O3 -ffast-math -fPIC -DNO_OUTPUT -DNO_STORAGE -o $@ -c $<
clean: 
	rm -f ${REBUILDABLES} *.dep *.so *.a
